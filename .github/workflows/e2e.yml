name: E2E Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  e2e-ios:
    name: ðŸ§ª E2E Tests (iOS)
    runs-on: foam
    steps:
      - name: ðŸ— Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ” Load secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          GOOGLE_SERVICES_IOS_PROD_BS4: op://ci-cd/foam-staging/GOOGLE_SERVICES_IOS_PROD_BS4

      - name: ðŸ“„ Decode Google Services file
        run: |
          echo "Decoding iOS Google Services plist..."
          echo "$GOOGLE_SERVICES_IOS_PROD_BS4" | base64 -d > GoogleService-Info-prod.plist
          echo "âœ… GoogleService-Info-prod.plist created"

      - name: Î› Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: bun

      - name: ðŸ“± Build E2E app
        run: |
          eas build --profile e2e --platform ios --local --non-interactive --output=build.tar.gz
        env:
          APP_VARIANT: e2e

      - name: ðŸ“¦ Extract app
        run: |
          tar -xzf build.tar.gz
          APP_PATH=$(find . -name "*.app" -type d | head -1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "Found app at: $APP_PATH"

      - name: ðŸŽ­ Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: ðŸ“± Boot Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[0-9A-F-]{36}')
          xcrun simctl boot "$DEVICE_ID" || true

      - name: ðŸ“² Install app on simulator
        run: |
          xcrun simctl install booted "$APP_PATH"

      - name: ðŸš€ Start mock server
        run: |
          bun run e2e:mock-server &
          sleep 3

      - name: ðŸ§ª Run Maestro tests
        run: |
          bun run maestro:test

      - name: ðŸ“¤ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results
          path: maestro-debug-output/
          retention-days: 7
