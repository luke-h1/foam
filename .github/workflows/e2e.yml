name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild (ignore cache)"
        type: boolean
        default: false

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  fingerprint:
    name: ðŸ” Check Fingerprint
    runs-on: foam
    outputs:
      hash: ${{ steps.fingerprint.outputs.hash }}
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: ðŸ— Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ” Calculate fingerprint
        id: fingerprint
        run: |
          HASH=$(npx expo-updates fingerprint:generate --platform ios 2>/dev/null | jq -r '.hash' || echo "unknown-$(date +%s)")
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“± iOS Fingerprint: $HASH"

      - name: ðŸ“‚ Check build cache
        id: cache
        if: ${{ !inputs.force_rebuild }}
        uses: actions/cache/restore@v4
        with:
          path: e2e-build.tar.gz
          key: e2e-ios-${{ steps.fingerprint.outputs.hash }}
          lookup-only: true

  build:
    name: ðŸ”¨ Build E2E App
    needs: fingerprint
    if: needs.fingerprint.outputs.cache-hit != 'true' || inputs.force_rebuild
    runs-on: foam
    steps:
      - name: ðŸ— Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ” Load secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          GOOGLE_SERVICES_IOS_PROD_BS4: op://ci-cd/foam-staging/GOOGLE_SERVICES_IOS_PROD_BS4

      - name: ðŸ“„ Decode Google Services file
        run: |
          echo "$GOOGLE_SERVICES_IOS_PROD_BS4" | base64 -d > GoogleService-Info-prod.plist

      - name: Î› Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: bun

      - name: ðŸ“± Build E2E app
        run: |
          eas build --profile e2e --platform ios --local --non-interactive --output=e2e-build.tar.gz
        env:
          APP_VARIANT: e2e

      - name: ðŸ’¾ Save build to cache
        uses: actions/cache/save@v4
        with:
          path: e2e-build.tar.gz
          key: e2e-ios-${{ needs.fingerprint.outputs.hash }}

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: e2e-build
          path: e2e-build.tar.gz
          retention-days: 30

  test:
    name: ðŸ§ª Run E2E Tests
    needs: [fingerprint, build]
    if: always() && needs.fingerprint.result == 'success'
    runs-on: macos-latest
    steps:
      - name: ðŸ— Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ“‚ Restore build from cache
        if: needs.build.result == 'skipped'
        uses: actions/cache/restore@v4
        with:
          path: e2e-build.tar.gz
          key: e2e-ios-${{ needs.fingerprint.outputs.hash }}

      - name: ðŸ“¥ Download build artifact
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: e2e-build

      - name: ðŸ“¦ Extract app
        run: |
          tar -xzf e2e-build.tar.gz
          APP_PATH=$(find . -name "*.app" -type d | head -1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "Found app at: $APP_PATH"

      - name: Î› Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: bun

      - name: ðŸ“¦ Push OTA update (JS changes only)
        if: needs.build.result == 'skipped'
        run: |
          echo "ðŸš€ Pushing OTA update for JS changes..."
          eas update --channel e2e --message "E2E: ${{ github.event.pull_request.title || github.sha }}" --non-interactive || true
        env:
          APP_VARIANT: e2e

      - name: ðŸŽ­ Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: ðŸ“± Boot Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[0-9A-F-]{36}')
          xcrun simctl boot "$DEVICE_ID" || true
          sleep 5

      - name: ðŸ“² Install app on simulator
        run: |
          xcrun simctl install booted "$APP_PATH"

      - name: ðŸš€ Start mock server
        run: |
          bun run e2e:mock-server &
          sleep 3

      - name: ðŸ§ª Run Maestro tests
        run: |
          bun run maestro:test

      - name: ðŸ“¤ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results
          path: maestro-debug-output/
          retention-days: 7
