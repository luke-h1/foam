name: Preview Build on PR

on:
  pull_request:
    types:
      - labeled
      - opened
      - synchronize

jobs:
  preview:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'preview-build') ||
      github.event.action == 'opened' ||
      github.event.action == 'synchronize'
    concurrency:
      group: preview-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ” Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/tutorial/eas/using-github/"
            exit 1
          fi

      - name: ğŸ— Setup repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ·ï¸ Check for preview-build label
        if: github.event.action != 'labeled'
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const hasLabel = labels.some(label => label.name === 'preview-build');
            core.setOutput('has-label', hasLabel);
            if (!hasLabel) {
              core.info('PR does not have preview-build label, skipping preview deployment');
            }

      - name: â­ï¸ Skip if no label
        if: github.event.action != 'labeled' && steps.check-label.outputs.has-label != 'true'
        run: |
          echo "PR does not have preview-build label. Add the 'preview-build' label to trigger preview deployment."
          exit 0

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: '.bun-version'

      - name: Setup Node
        uses: actions/setup-node@v4.1.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: bun
          patch-watchers: false

      - name: ğŸš€ Create preview
        uses: expo/expo-github-action/preview@v8
        with:
          command: eas update --auto --branch pr-${{ github.event.pull_request.number }} --non-interactive --local

