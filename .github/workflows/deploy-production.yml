name: Deploy production (OTA or build)

on:
  workflow_dispatch:

jobs:
  determine_and_deploy:
    runs-on: foam
    timeout-minutes: 40
    concurrency: main-deploy-${{ github.run_id }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: üîé Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/tutorial/eas/using-github/"
            exit 1
          fi

      - name: üèó Setup repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Load secrets
        id: load_secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          TWITCH_CLIENT_ID: op://ci-cd/foam-staging/TWITCH_CLIENT_ID
          TWITCH_CLIENT_SECRET: op://ci-cd/foam-staging/TWITCH_CLIENT_SECRET
          AUTH_PROXY_API_BASE_URL: op://ci-cd/foam-staging/AUTH_PROXY_API_BASE_URL
          AUTH_PROXY_API_KEY: op://ci-cd/foam-staging/AUTH_PROXY_API_KEY
          SENTRY_AUTH_TOKEN: op://ci-cd/foam-staging/SENTRY_AUTH_TOKEN
          GOOGLE_SERVICES_IOS_PROD_BS4: op://ci-cd/foam-staging/GOOGLE_SERVICES_IOS_PROD_BS4
          GOOGLE_SERVICES_ANDROID_PROD_BS4: op://ci-cd/foam-staging/GOOGLE_SERVICES_ANDROID_PROD_BS4
          OP_ENV_FILE: ".env"

      - name: üìÑ Decode and write Google service files
        run: |
          if [ -z "$GOOGLE_SERVICES_ANDROID_PROD_BS4" ]; then
            echo "Error: GOOGLE_SERVICES_ANDROID_PROD_BS4 is not set"
            exit 1
          fi
          if [ -z "$GOOGLE_SERVICES_IOS_PROD_BS4" ]; then
            echo "Error: GOOGLE_SERVICES_IOS_PROD_BS4 is not set"
            exit 1
          fi
          
          echo "Decoding Android Google Services JSON..."
          echo "$GOOGLE_SERVICES_ANDROID_PROD_BS4" | base64 -d > google-services-prod.json
          
          echo "Decoding iOS Google Services plist..."
          echo "$GOOGLE_SERVICES_IOS_PROD_BS4" | base64 -d > GoogleService-Info-prod.plist
          
          echo "‚úÖ Google service files written successfully"

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: '.bun-version'

      - name: Setup Node
        uses: actions/setup-node@v4.1.0
        with:
          node-version-file: .nvmrc

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: Œõ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: bun
          patch-watchers: false

      - name: üîç Check if build is needed (fingerprint check)
        id: fingerprint_check
        uses: expo/expo-github-action/continuous-deploy-fingerprint-info@main
        with:
          profile: production
          branch: production

      - name: üìä Debug fingerprint check outputs
        run: |
          echo "build-needed: ${{ steps.fingerprint_check.outputs.build-needed }}"
          echo "ios-build-exists: ${{ steps.fingerprint_check.outputs.ios-build-exists }}"
          echo "android-build-exists: ${{ steps.fingerprint_check.outputs.android-build-exists }}"

      - name: üîß Normalize build-needed value
        id: normalize_build_needed
        run: |
          if [ -z "${{ steps.fingerprint_check.outputs.build-needed }}" ]; then
            echo "build-needed is blank, setting to true"
            echo "build-needed=true" >> $GITHUB_OUTPUT
          else
            echo "build-needed is not blank, setting to false"
            echo "build-needed=false" >> $GITHUB_OUTPUT
          fi

      - name: üìù Bump version in app.config.ts
        if: steps.normalize_build_needed.outputs.build-needed == 'true'
        run: |
          # Read current version using sed (more portable than grep -oP)
          CURRENT_VERSION=$(sed -n "s/.*const VERSION = '\\([^']*\\)'.*/\\1/p" app.config.ts)
          echo "Current version: $CURRENT_VERSION"
          
          # Parse version parts (assuming semver format like 0.0.36)
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "New version: $NEW_VERSION"
          
          sed -i.bak "s/const VERSION = '$CURRENT_VERSION'/const VERSION = '$NEW_VERSION'/" app.config.ts
          rm -f app.config.ts.bak
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "VERSION_BUMPED=true" >> $GITHUB_ENV

      - name: üíæ Commit version bump
        if: steps.normalize_build_needed.outputs.build-needed == 'true' && env.VERSION_BUMPED == 'true'
        run: |
          git config --global user.name 'luke-h1'
          git config --global user.email 'luke-h1@users.noreply.github.com'
          git config --global github.user 'luke-h1'
          git add app.config.ts
          git commit -m "chore(release): bump version to ${{ env.NEW_VERSION }} [skip ci]" || exit 0
          git push

      - name: üè∑Ô∏è Check if tag exists
        if: steps.normalize_build_needed.outputs.build-needed == 'true' && env.VERSION_BUMPED == 'true'
        id: check_tag
        run: |
          TAG_NAME="v${{ env.NEW_VERSION }}"
          if git ls-remote --tags origin "$TAG_NAME" | grep -q "$TAG_NAME"; then
            echo "tag-exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME already exists"
          else
            echo "tag-exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME does not exist"
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: üè∑Ô∏è Create GitHub tag
        if: steps.normalize_build_needed.outputs.build-needed == 'true' && env.VERSION_BUMPED == 'true' && steps.check_tag.outputs.tag-exists == 'false'
        run: |
          git tag -a "v${{ env.NEW_VERSION }}" -m "v${{ env.NEW_VERSION }}"
          git push origin "v${{ env.NEW_VERSION }}"
          echo "‚úÖ Created tag v${{ env.NEW_VERSION }}"

      - name: üì¶ Check if release exists
        if: steps.normalize_build_needed.outputs.build-needed == 'true' && env.VERSION_BUMPED == 'true'
        id: check_release
        run: |
          TAG_NAME="v${{ env.NEW_VERSION }}"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "release-exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG_NAME already exists"
          else
            echo "release-exists=false" >> $GITHUB_OUTPUT
            echo "Release $TAG_NAME does not exist (HTTP $RESPONSE)"
          fi

      - name: üì¶ Create GitHub release
        if: steps.normalize_build_needed.outputs.build-needed == 'true' && env.VERSION_BUMPED == 'true' && steps.check_release.outputs.release-exists == 'false'
        run: |
          TAG_NAME="v${{ env.NEW_VERSION }}"
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -d "{
              \"tag_name\": \"$TAG_NAME\",
              \"name\": \"Release $TAG_NAME\",
              \"body\": \"Production release $TAG_NAME\",
              \"target_commitish\": \"main\",
              \"draft\": false,
              \"prerelease\": false
            }"
          echo "‚úÖ Created release $TAG_NAME"

      - name: üöÄ Create OTA update
        if: steps.normalize_build_needed.outputs.build-needed == 'false'
        run: |
          bun eas update --auto --branch production --non-interactive --local

      - name: üèóÔ∏è Trigger build
        if: steps.normalize_build_needed.outputs.build-needed == 'true'
        run: |
          EXPO_PUBLIC_ENABLE_TREESHACKING=1 EXPO_APPLE_TEAM_ID="XJA7HDCMMY" bun eas build --profile production --platform ios --non-interactive --no-wait --local --output ./app-production.abd

      - name: Submit build
        if: steps.normalize_build_needed.outputs.build-needed == 'true'
        run: | 
          bun run eas submit -p ios --path ./app-production.abd
