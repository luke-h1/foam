name: Deploy native or OTA

on:
  workflow_dispatch:
    inputs:
      deploy_type:
        description: "Deployment type"
        required: true
        type: choice
        default: "auto"
        options:
          - auto # Detect using fingerprint
          - ota # Force OTA update
          - build # Force native build
      platform:
        description: "Platform to deploy"
        required: false
        type: choice
        default: "all"
        options:
          - all
          - ios
          - android
      runtimeVersion:
        description: "Runtime version (x.x.x format) to target for OTA updates"
        required: false
        type: string
      dry_run:
        description: "Dry run mode (skip release creation)"
        required: false
        type: boolean
        default: false

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  prepare:
    name: üìã Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag: ${{ steps.get_version.outputs.tag }}
      runtime_version: ${{ steps.validate_runtime.outputs.runtime_version }}
    steps:
      - name: üèó Checkout
        uses: actions/checkout@v4

      - name: üßê Validate runtime version
        id: validate_runtime
        if: ${{ inputs.runtimeVersion }}
        env:
          RUNTIME_VERSION: ${{ inputs.runtimeVersion }}
        run: |
          if [[ ! "$RUNTIME_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid runtime version format: $RUNTIME_VERSION"
            echo "   Expected format: x.x.x (e.g., 1.0.0)"
            exit 1
          fi
          echo "‚úÖ Runtime version is valid: $RUNTIME_VERSION"
          echo "runtime_version=$RUNTIME_VERSION" >> $GITHUB_OUTPUT

      - name: üìå Get version from app.config.ts
        id: get_version
        run: |
          VERSION=$(grep "const VERSION = " app.config.ts | sed "s/const VERSION = '//g" | sed "s/';//g" | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå App Version: $VERSION"

  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    steps:
      - name: üèó Checkout
        uses: actions/checkout@v4

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üß™ Run tests
        run: bun run test:ci

      - name: üìù TypeScript check
        run: bun run ts:check

  detect-changes:
    name: üîç Detect Changes
    needs: [prepare, test]
    runs-on: ubuntu-latest
    permissions:
      actions: read
    outputs:
      fingerprint-changed: ${{ steps.compare.outputs.changed }}
      ios-fingerprint: ${{ steps.fingerprint.outputs.ios }}
      android-fingerprint: ${{ steps.fingerprint.outputs.android }}
      deploy-type: ${{ steps.decide.outputs.deploy-type }}
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: üèó Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need history for comparison

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üîç Calculate current fingerprints
        id: fingerprint
        run: |
          IOS_FP=$(npx expo-updates fingerprint:generate --platform ios 2>/dev/null | jq -r '.hash' || echo "unknown")
          ANDROID_FP=$(npx expo-updates fingerprint:generate --platform android 2>/dev/null | jq -r '.hash' || echo "unknown")

          echo "ios=$IOS_FP" >> $GITHUB_OUTPUT
          echo "android=$ANDROID_FP" >> $GITHUB_OUTPUT
          echo "üì± iOS Fingerprint: $IOS_FP"
          echo "ü§ñ Android Fingerprint: $ANDROID_FP"

      - name: üìÇ Load previous fingerprints
        id: previous
        uses: actions/cache/restore@v4
        with:
          path: .fingerprint-cache
          key: fingerprint-${{ github.ref_name }}
          restore-keys: |
            fingerprint-main
            fingerprint-

      - name: üîÑ Compare fingerprints
        id: compare
        run: |
          CHANGED="false"

          if [ -f .fingerprint-cache/ios ]; then
            PREV_IOS=$(cat .fingerprint-cache/ios)
            if [ "$PREV_IOS" != "${{ steps.fingerprint.outputs.ios }}" ]; then
              echo "‚ö†Ô∏è iOS fingerprint changed: $PREV_IOS ‚Üí ${{ steps.fingerprint.outputs.ios }}"
              CHANGED="true"
            else
              echo "‚úÖ iOS fingerprint unchanged"
            fi
          else
            echo "‚ÑπÔ∏è No previous iOS fingerprint found (first run)"
            CHANGED="true"
          fi

          if [ -f .fingerprint-cache/android ]; then
            PREV_ANDROID=$(cat .fingerprint-cache/android)
            if [ "$PREV_ANDROID" != "${{ steps.fingerprint.outputs.android }}" ]; then
              echo "‚ö†Ô∏è Android fingerprint changed: $PREV_ANDROID ‚Üí ${{ steps.fingerprint.outputs.android }}"
              CHANGED="true"
            else
              echo "‚úÖ Android fingerprint unchanged"
            fi
          else
            echo "‚ÑπÔ∏è No previous Android fingerprint found (first run)"
            CHANGED="true"
          fi

          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: ü§î Decide deployment type
        id: decide
        run: |
          MANUAL_TYPE="${{ inputs.deploy_type }}"

          if [ "$MANUAL_TYPE" == "ota" ]; then
            echo "deploy-type=ota" >> $GITHUB_OUTPUT
            echo "üì¶ Manual: OTA update requested"
          elif [ "$MANUAL_TYPE" == "build" ]; then
            echo "deploy-type=build" >> $GITHUB_OUTPUT
            echo "üî® Manual: Native build requested"
          elif [ "${{ steps.compare.outputs.changed }}" == "true" ]; then
            echo "deploy-type=build" >> $GITHUB_OUTPUT
            echo "üî® Auto: Native changes detected - build required"
          else
            echo "deploy-type=ota" >> $GITHUB_OUTPUT
            echo "üì¶ Auto: No native changes - OTA update"
          fi

      - name: üè∑Ô∏è Generate release tag (preliminary)
        id: tag
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          DEPLOY_TYPE="${{ steps.decide.outputs.deploy-type }}"

          if [ "$DEPLOY_TYPE" == "ota" ]; then
            # Preliminary tag for OTA - final tag will use update group ID in release job
            TAG="ota-pending"
            echo "üè∑Ô∏è OTA release - final tag will be determined after update (ota-{updateId})"
          else
            TAG="${VERSION}"
            echo "üè∑Ô∏è Native release tag: $TAG"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: üìä Summary
        run: |
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Fingerprint | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | \`${{ steps.fingerprint.outputs.ios }}\` | ${{ steps.compare.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | \`${{ steps.fingerprint.outputs.android }}\` | ${{ steps.compare.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Decision:** ${{ steps.decide.outputs.deploy-type == 'build' && 'üî® Native Build' || 'üì¶ OTA Update' }}" >> $GITHUB_STEP_SUMMARY

  build:
    name: üî® Native Build
    needs: [prepare, detect-changes]
    if: needs.detect-changes.outputs.deploy-type == 'build'
    runs-on: foam
    concurrency: eas-build-${{ inputs.platform || 'all' }}
    steps:
      - name: üèó Checkout
        uses: actions/checkout@v4

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: Load secrets
        id: load_secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          TWITCH_CLIENT_ID: op://ci-cd/foam-staging/TWITCH_CLIENT_ID
          TWITCH_CLIENT_SECRET: op://ci-cd/foam-staging/TWITCH_CLIENT_SECRET
          AUTH_PROXY_API_BASE_URL: op://ci-cd/foam-staging/AUTH_PROXY_API_BASE_URL
          AUTH_PROXY_API_KEY: op://ci-cd/foam-staging/AUTH_PROXY_API_KEY
          SENTRY_AUTH_TOKEN: op://ci-cd/foam-staging/SENTRY_AUTH_TOKEN
          GOOGLE_SERVICES_IOS_PROD_BS4: op://ci-cd/foam-staging/GOOGLE_SERVICES_IOS_PROD_BS4
          GOOGLE_SERVICES_ANDROID_PROD_BS4: op://ci-cd/foam-staging/GOOGLE_SERVICES_ANDROID_PROD_BS4
          SLACK_WEBHOOK_URL: op://ci-cd/foam-staging/SLACK_WEBHOOK_URL
          OP_ENV_FILE: ".env"

      - name: üìÑ Decode and write Google service files
        run: |
          if [ -z "$GOOGLE_SERVICES_ANDROID_PROD_BS4" ]; then
            echo "Error: GOOGLE_SERVICES_ANDROID_PROD_BS4 is not set"
            exit 1
          fi
          if [ -z "$GOOGLE_SERVICES_IOS_PROD_BS4" ]; then
            echo "Error: GOOGLE_SERVICES_IOS_PROD_BS4 is not set"
            exit 1
          fi

          echo "Decoding Android Google Services JSON..."
          echo "$GOOGLE_SERVICES_ANDROID_PROD_BS4" | base64 -d > google-services-prod.json

          echo "Decoding iOS Google Services plist..."
          echo "$GOOGLE_SERVICES_IOS_PROD_BS4" | base64 -d > GoogleService-Info-prod.plist

          echo "‚úÖ Google service files written successfully"

      - name: üìù Generate GoogleService-Info.plist
        run: |
          # Decode base64 and write directly to file
          echo "$GOOGLE_SERVICES_IOS_PROD_BS4" | base64 -d > GoogleService-Info-prod.plist

          # Verify the file was created
          if [ -f "GoogleService-Info-prod.plist" ]; then
            echo "‚úÖ GoogleService-Info-prod.plist created successfully"
            head -5 GoogleService-Info-prod.plist || true
          else
            echo "‚ùå Failed to create GoogleService-Info-prod.plist"
            exit 1
          fi

      - name: Œõ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: bun

      - name: üìÅ Prepare build artifacts dir
        run: mkdir -p build-artifacts

      - name: üî® Build & Submit
        run: |
          PLATFORM="${{ inputs.platform || 'all' }}"

          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "ios" ]; then
            echo "Building iOS..."
            EXPO_PUBLIC_ENABLE_TREESHACKING=1 EXPO_APPLE_TEAM_ID="XJA7HDCMMY" bun run eas build --platform ios --profile production --local --non-interactive --output=./build-artifacts/app.ipa && bun run eas submit -p ios --path ./build-artifacts/app.ipa
          fi

          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "android" ]; then
            echo "Building Android..."
            eas build --platform android --profile production --auto-submit --non-interactive --no-wait --local
          fi
        env:
          APP_VARIANT: production
          TWITCH_CLIENT_ID: ${{ env.TWITCH_CLIENT_ID }}
          TWITCH_CLIENT_SECRET: ${{ env.TWITCH_CLIENT_SECRET }}
          AUTH_PROXY_API_BASE_URL: ${{ env.AUTH_PROXY_API_BASE_URL }}
          AUTH_PROXY_API_KEY: ${{ env.AUTH_PROXY_API_KEY }}

      - name: üíæ Save fingerprints for next run
        run: |
          mkdir -p .fingerprint-cache
          echo "${{ needs.detect-changes.outputs.ios-fingerprint }}" > .fingerprint-cache/ios
          echo "${{ needs.detect-changes.outputs.android-fingerprint }}" > .fingerprint-cache/android

      - name: üìÇ Cache fingerprints
        uses: actions/cache/save@v4
        with:
          path: .fingerprint-cache
          key: fingerprint-${{ github.ref_name }}-${{ github.sha }}

      - name: üìä Summary
        run: |
          echo "## Native Build Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** ${{ inputs.platform || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** production" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-submit:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Fingerprints saved for future comparison." >> $GITHUB_STEP_SUMMARY

  ota:
    name: üì¶ OTA Update
    needs: [prepare, detect-changes]
    if: needs.detect-changes.outputs.deploy-type == 'ota'
    runs-on: ubuntu-latest
    concurrency: eas-update-production
    outputs:
      ios_update_id: ${{ steps.publish.outputs.ios_update_id }}
      android_update_id: ${{ steps.publish.outputs.android_update_id }}
      update_group_id: ${{ steps.publish.outputs.update_group_id }}
    steps:
      - name: üèó Checkout
        uses: actions/checkout@v4

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: Œõ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: bun

      - name: üì¶ Publish OTA Update
        id: publish
        run: |
          PLATFORM="${{ inputs.platform || 'all' }}"
          RUNTIME_VERSION="${{ needs.prepare.outputs.runtime_version }}"

          if [ "$PLATFORM" == "all" ]; then
            PLATFORM_FLAG="--platform all"
          else
            PLATFORM_FLAG="--platform $PLATFORM"
          fi

          # Build runtime version flag if specified
          RUNTIME_FLAG=""
          if [ -n "$RUNTIME_VERSION" ]; then
            RUNTIME_FLAG="--runtime-version $RUNTIME_VERSION"
            echo "üéØ Targeting runtime version: $RUNTIME_VERSION"
          fi

          # Capture the JSON output from eas update
          UPDATE_OUTPUT=$(eas update --channel production --environment production --message "Deploy: ${{ github.event.head_commit.message || github.sha }}" $PLATFORM_FLAG $RUNTIME_FLAG --non-interactive --clear-cache --json 2>/dev/null || echo "[]")

          # Parse update IDs from the JSON output
          IOS_UPDATE_ID=$(echo "$UPDATE_OUTPUT" | jq -r '.[] | select(.platform == "ios") | .id' 2>/dev/null || echo "")
          ANDROID_UPDATE_ID=$(echo "$UPDATE_OUTPUT" | jq -r '.[] | select(.platform == "android") | .id' 2>/dev/null || echo "")
          UPDATE_GROUP_ID=$(echo "$UPDATE_OUTPUT" | jq -r '.[0].group' 2>/dev/null || echo "")

          echo "ios_update_id=$IOS_UPDATE_ID" >> $GITHUB_OUTPUT
          echo "android_update_id=$ANDROID_UPDATE_ID" >> $GITHUB_OUTPUT
          echo "update_group_id=$UPDATE_GROUP_ID" >> $GITHUB_OUTPUT

          echo "üì¶ Published OTA Update:"
          echo "  iOS Update ID: $IOS_UPDATE_ID"
          echo "  Android Update ID: $ANDROID_UPDATE_ID"
          echo "  Update Group ID: $UPDATE_GROUP_ID"
          if [ -n "$RUNTIME_VERSION" ]; then
            echo "  Runtime Version: $RUNTIME_VERSION"
          fi
        env:
          APP_VARIANT: production

      - name: üíæ Save fingerprints for next run
        run: |
          mkdir -p .fingerprint-cache
          echo "${{ needs.detect-changes.outputs.ios-fingerprint }}" > .fingerprint-cache/ios
          echo "${{ needs.detect-changes.outputs.android-fingerprint }}" > .fingerprint-cache/android

      - name: üìÇ Cache fingerprints
        uses: actions/cache/save@v4
        with:
          path: .fingerprint-cache
          key: fingerprint-${{ github.ref_name }}-${{ github.sha }}

      - name: üìä Summary
        run: |
          echo "## OTA Update Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** production" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** ${{ inputs.platform || 'all' }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ needs.prepare.outputs.runtime_version }}" ]; then
            echo "- **Runtime Version:** \`${{ needs.prepare.outputs.runtime_version }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Group ID:** \`${{ steps.publish.outputs.update_group_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Update deployed instantly to all users!" >> $GITHUB_STEP_SUMMARY

  release:
    name: üìù Create Release
    needs: [prepare, detect-changes, build, ota]
    if: always() && needs.detect-changes.result == 'success' && (needs.build.result == 'success' || needs.build.result == 'skipped') && (needs.ota.result == 'success' || needs.ota.result == 'skipped') && !inputs.dry_run
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      version: ${{ needs.prepare.outputs.version }}
      tag: ${{ steps.release_tag.outputs.tag }}
      deployment_type: ${{ needs.detect-changes.outputs.deploy-type }}
      release_notes: ${{ steps.create_release.outputs.release_notes }}
      ios_update_id: ${{ needs.ota.outputs.ios_update_id || '' }}
      android_update_id: ${{ needs.ota.outputs.android_update_id || '' }}
      update_group_id: ${{ needs.ota.outputs.update_group_id || '' }}
      release_url: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_tag.outputs.tag }}
    steps:
      - name: üèó Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Determine release tag
        id: release_tag
        run: |
          DEPLOY_TYPE="${{ needs.detect-changes.outputs.deploy-type }}"
          VERSION="${{ needs.prepare.outputs.version }}"
          UPDATE_GROUP_ID="${{ needs.ota.outputs.update_group_id }}"

          if [ "$DEPLOY_TYPE" == "ota" ] && [ -n "$UPDATE_GROUP_ID" ]; then
            # Use ota-{updateId} format for OTA releases
            TAG="ota-${UPDATE_GROUP_ID}"
            echo "üè∑Ô∏è OTA Release tag: $TAG (using update group ID)"
          elif [ "$DEPLOY_TYPE" == "ota" ]; then
            # Fallback if no update group ID (shouldn't happen)
            TAG="ota-${VERSION}-${{ github.run_number }}"
            echo "üè∑Ô∏è OTA Release tag: $TAG (fallback)"
          else
            # Native builds use version-based tag
            TAG="${VERSION}"
            echo "üè∑Ô∏è Native Release tag: $TAG"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: üìù Create Release
        id: create_release
        uses: ./.github/actions/create-release
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dry: ${{ inputs.dry_run }}
          variant: production
          version: ${{ needs.prepare.outputs.version }}
          tag: ${{ steps.release_tag.outputs.tag }}
          deployment_type: ${{ needs.detect-changes.outputs.deploy-type == 'ota' && 'ota' || 'native' }}
          ios_fingerprint: ${{ needs.detect-changes.outputs.ios-fingerprint || '' }}
          android_fingerprint: ${{ needs.detect-changes.outputs.android-fingerprint || '' }}
          ios_update_id: ${{ needs.ota.outputs.ios_update_id || '' }}
          android_update_id: ${{ needs.ota.outputs.android_update_id || '' }}
          update_group_id: ${{ needs.ota.outputs.update_group_id || '' }}
          runtime_version: ${{ needs.prepare.outputs.runtime_version || '' }}
          commit_changelog: 'true'

      - name: üìä Summary
        run: |
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ steps.release_tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ needs.detect-changes.outputs.deploy-type == 'ota' && 'üì¶ OTA Update' || 'üî® Native Build' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ GitHub release and CHANGELOG.md updated!" >> $GITHUB_STEP_SUMMARY

  slack-notify:
    name: üì¢ Slack Notification
    needs: [release]
    if: always() && needs.release.result == 'success' && !inputs.dry_run
    runs-on: ubuntu-latest
    steps:
      - name: üèó Checkout
        uses: actions/checkout@v4

      - name: Load secrets
        id: secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          SLACK_WEBHOOK_URL: op://ci-cd/foam-staging/SLACK_WEBHOOK_URL

      - name: Send Slack notification
        uses: ./.github/actions/slack-deploy-notification
        with:
          webhook_url: ${{ steps.secrets.outputs.SLACK_WEBHOOK_URL }}
          version: ${{ needs.release.outputs.version }}
          deployment_type: ${{ needs.release.outputs.deployment_type }}
          tag: ${{ needs.release.outputs.tag }}
          ios_update_id: ${{ needs.release.outputs.ios_update_id }}
          android_update_id: ${{ needs.release.outputs.android_update_id }}
          update_group_id: ${{ needs.release.outputs.update_group_id }}
          release_notes: ${{ needs.release.outputs.release_notes }}
          release_url: ${{ needs.release.outputs.release_url }}
          repository: ${{ github.repository }}
